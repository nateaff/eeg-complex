---
title: "Seizure Prediction"
author: "Nathanael Aff"
date: 2017-07-10
output: 
  html_document:
    code_folding: hide
    toc: true
---
  
<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->

```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```


<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

### Introduction 

Electroencephalograms(EEG) are non-stationary and non-homogeneous signals. In other words, EEG signals exhibit abrupt changes in their statistical distribution and functional behavior. EEG signals can also be considered as points in a high-dimensional space. A common way of reducing the EEG signal to a more tractable, lower-dimensional space is by some combination of features extraction and signal decomposition -- i.e., spectral, wavelet, principal component(PCA) or independent component(ICA) decomposition. Feature selection and decompositions of the raw signal entail an averaging over possibly inhomogeneous segments of the EEG signal. 

The theory of the $\varepsilon-$complexity of continuous functions was developed as a model free way of capturing inhomogeneity in a source signal. With that in mind, we used changes points in the complexity coefficients to segment the raw signal. The spectral decomposition of the EEG signal along with a small set of nonlinear features were segmented based on changes in the complexity coefficients and averages on these segments were used as features in the final classifier. 

Segmentation based on complexity coefficients was compared to several models that used uniform partitions of the signal. Segmentation based on complexity coefficients did not perform better than the uniform partition schemes.


### Classification models


The plot below illustrates a partition of spectral features based on change points in the complexity coefficient $B$. In total, 6 segmentation models were used: segmentation based on complexity coefficients $A$ and $B$, individually and combined, and three models using uniform partitions. 


```{r, segment-plot1}
 devtools::load_all()
  knitr::read_chunk("../code/eeg-segment-plot.R")
```

```{r segment-plot2, fig.height = 4, fig.cap = "Segmentation of trial one based on the complexity coefficient $B$. Only spectral features are shown."}
  <<eeg-segment-create>>

  <<eeg-segment-plot>>

```

We discuss the data in more detail below. In short, there were 26 trials with 9 seizure responses. The underlying classifier is a random forest which produces some random variation in classification results. The classification performance reported in the table below is the mean balanced accuracy based on 30 iterations of 5-fold cross-validation. Within individual folds classes were relatively balanced but no other class balancing procedure was used. The final prediction probability is a sum of the outcome probabilities weighted by partition length. 

Models were built separately for each EEG channel. The mean balanced accuracy for each model and channel is reported below. All models performed better on channels 1 and 2: these are local field potential(LFP) channels which record the activity of a small set of neurons in the thalamus. The regular partition models of 8 and 15 partitions performed better across most channels. In particular, the performance of the models based on the complexity coefficients dropped for channels 5 and 6.

Because of the small number of trials and some inherent flaws in the data, further tests would be needed to know if these results generalize to other conditions. In particular, the detection of change points in the complexity coefficients is sensitive to the resolution at which the feature is calculated.

```{r eeg-tables1}
  knitr::read_chunk("../code/eeg-tables.R")
```


```{r eeg-tables2}
  <<eeg-tables>>
```




### Data

The EEG come from mice with a genetic mutation similar to Dravet syndrome that makes them prone to epilepsy. The mice are also genetically modified to allow for direct stimulation of neurons by a laser pulse.

Data was gathered from 13 distinct time periods during which a laser stimulus was applied between one to four times. There were 26 trials in total. The 4-minute segments preceding the stimulus was used to predict outcomes. Since the seizures are induced and not naturally occuring, features associated with seizure response may be different, and possibly harder to detect, than those associated with a spotaneous seizure. 

```{r, egg-plot1}
  devtools::load_all()
  knitr::read_chunk("../code/eeg-plot.R")
```


```{r egg-plot2, fig.height = 4, fig.cap = "8 second window of EEG inclduing the start appplication of a laser stimulus."}
  <<eeg-plot>>
```

While we were able to prediction seizures on with a relatively high degree of accuracy -- over 80% for some channels, there are significant limitations to the data. First and foremost, all seizures came from an individual mouse. We can only make limited inferences about features related to seizure responses without additional data. Variations in the features could be specific to the biology or measurement devices particular to that mouse. 

Seizures also occured mainly in the same series of trials. A plot below shows a shematic diagram of the trials. Each bar represents a single trial. Filled boxes indicate a trial period and green bars indicate an application of the stimulus. Most seizures occured in a trial following a previous seizure: these are indicated by cyan boxes. 

Again, features associated with seizures may simply be features that occur following a seizure, not preceeding it. 


```{r, trials-plot1}
  knitr::read_chunk("../code/eeg-trial-plot.R")
```


```{r trial-plot2, fig.cap = "Schematic of the trial time periods. A seizures is indicated as a 'repsonse' and initial seizures and secondary seizures are indicated by color."}
  <<trialplot>>
```

The plot below shows the probability of seizure as estimated by a single model for each trial. Pink and cyan indicate seizure responses. For most trials the model separates seizure and non-seizure trials fairly well. However, the initial seizure responses are much closer to the threshold than the later seizure trials.


```{r, cv-ch1}
  knitr::read_chunk("../code/eeg-cv-ch1-plot.R")
```


```{r cv-ch2, fig.cap = "Probability of seizure for model built on channel 1 using complexity coefficients."}
  <<cv-ch1-plot>>
```

### Feature importance

Despite variations in classification performance, variable importance was similar across models. The variable importance for two models plotted in the figure below. Both models were build on data from channel 1. On the left is the model segmented on the combined complexity coefficients A and B. On the right is a model with 8 uniform partitions. 

```{r, eeg-importance1}
  knitr::read_chunk("../code/eeg-classify-roc-import.R")
```

```{r egg-importance2, fig.height = 4, fig.cap = "Variable importance (mean-decrease in GINI) for all model and channel combinations. On the left is the model segmented by complexity coefficients A+B. On the right is the model with 8 uniform partitions."}
  <<eeg-importance-plot>>
```

Although the underlying random forest classifier can be highly non-linear, so differences in distributions of the features may not be obvious, the pattern of variable importance is reflected in the differences of distributions of the raw features. The boxplots below show clear differences in the distributions of the relative gamma and theta for channel 1. 


```{r, eeg-boxplot1}
  knitr::read_chunk("../code/eeg-boxplot-ch1.R")
```

```{r egg-boxplot2, fig.height = 4, fig.cap = "Feature distribution for Channel 1"}
  <<eeg-boxplotpanel-ch1>>
```
Channel 1 represents an LFP or local field potential signal, captured from a smaller cluster of neurons in the thalamus. Channel 3 is an iEEG or external EEG sensor placed on the brain surface.

For channel 3 direction of the difference for relative gamma and theta are reversed. Where differences in the beta distribution for seizure an non-seizure trials are not significant for channel 1, for channel three the differences are clear. The difference in distributions is also reflected in the variable importance in the previous plot, as are differences in Hurst and spectral entropy features.

```{r egg-boxplot3, fig.height = 4, fig.cap = "Feature distribution for Channel 3"}
  <<eeg-boxplotpanel-ch3>>
```


### Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
