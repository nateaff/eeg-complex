<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Nathanael Aff" />

<meta name="date" content="2017-07-10" />

<title>Seizure Prediction</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">eeg-complex</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="simulations.html">Simulations</a>
</li>
<li>
  <a href="complexity-coefficients.html">Complexity Coefficients</a>
</li>
<li>
  <a href="seizure-prediction.html">Seizure Prediction</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/nateaff/eeg-complex">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Seizure Prediction</h1>
<h4 class="author"><em>Nathanael Aff</em></h4>
<h4 class="date"><em>2017-07-10</em></h4>

</div>


<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
<!-- Update knitr chunk options -->
<!-- Insert the date the file was last updated -->
<p><strong>Last updated:</strong> 2017-07-23</p>
<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
<p><strong>Code version:</strong> ff35075</p>
<pre class="r"><code>  devtools::load_all()
  knitr::read_chunk(&quot;../code/eegplot.R&quot;)</code></pre>
<pre class="r"><code>  eeg &lt;- readRDS(cache_file(&quot;eegsnip&quot;, prefix = &quot;eeg&quot;))
  
  # dim(eeg)
  fs &lt;- 1220.703
  
  plot_range &lt;- function(a,b){
    oldpar = par() 
    par(mfrow = c(6,  1), mar = c(1, 1, 1, 1))
    for(k in 1:6){
     plot(eeg[k, a:b], 
           type = &#39;l&#39;, 
           col = &quot;gray20&quot;, 
           lwd = 1.5,
           axes = FALSE,
           frame.plot = FALSE)
    }
    
  }
  
  secs = 8
  a = 37000
  b = a + fs*secs
  plot_range(a,b)</code></pre>
<div class="figure" style="text-align: center">
<img src="figure/seizure-prediction.Rmd/egg-plot2-1.png" alt="8 second window of EEG inclduing the start appplication of a laser stimulus." width="672" />
<p class="caption">
8 second window of EEG inclduing the start appplication of a laser stimulus.
</p>
</div>
<div id="classifier" class="section level2">
<h2>Classifier</h2>
<pre class="r"><code>  knitr::read_chunk(&quot;../code/eeg-segment-plot.R&quot;)</code></pre>
<pre class="r"><code>  library(ggplot2)
  library(dplyr)
  library(viridis)
  library(ecomplex)
  prefix    = &quot;eeg&quot;
  seed      = 2017
  
  # Derived features. 30 Trials : 6 channels : 15 features
  feature_df &lt;-readRDS(cache_file(&quot;mod_all_features&quot;, prefix))
  # Load meta data 
  trial_df &lt;- readRDS(cache_file(&quot;mod_trial_segments&quot;, &quot;eeg&quot;))
  
  df &lt;- do.call(rbind, feature_df) %&gt;% 
        cbind(., trial_df) %&gt;% 
        dplyr::filter(., window == 240)
  
  df$trial &lt;- 1:26
  
  ch = 1; colnums = c(5:9,  13:15); tnum = 8
  
  dfch &lt;- df[[ch]][[tnum]]
  res &lt;- palarm(dfch$ecomp.cspline_B)
  
  seg_plot &lt;- function(startn, stopn, title =&quot;&quot;){
    segcol = adjustcolor(&quot;tomato3&quot;, 0.9)
    pal  = c(&quot;gray20&quot;, segcol, viridis::viridis(256)[c(1, 30, 60, 90, 120)])
  
    plot(dfch$ecomp.cspline_B + 3, 
                    type = &#39;l&#39;,  
                    col = adjustcolor(&quot;gray20&quot;, 0.6), 
                    lwd = 2,
                    lty = 1, 
                    ylim = c(0,2.2), 
                    xlim = c(0,120), 
                    xlab = &quot;Time&quot;,
                    yaxt = &quot;n&quot;, 
                    ylab = &quot;&quot;, 
                    main = title)
    lines(res$means + 3, type = &#39;l&#39;, xlim=c(0,120), col=segcol, lwd=2, lty= 1 )
    for(k in startn:stopn) lines(dfch[ , 4 + k] + 0.5*(k-startn), 
                       lwd = 2, 
                       col = pal[k + 2])
    for(k in res$kout) abline(v = k, col = segcol, lwd = 1.5, lty = 2)
  }
  
  # pdf(file.path(getwd(), paste0(&quot;figures/&quot;, prefix, &quot;-segment-plot.pdf&quot;)), 
  #     width = 9, height = 4)
  
  par(mfrow = c(1,2), mar = c(2,1,2,1))
  seg_plot(1,2, &quot;Segmentation of Delta, Theta&quot;)
  seg_plot(3,5, &quot;Segmentation of Alpha, Beta, Gamma&quot;)</code></pre>
<div class="figure" style="text-align: center">
<img src="figure/seizure-prediction.Rmd/segment-plot2-1.png" alt="Segmentation of trial one based on the complexity coefficient $B$. Only spectral features are shown." width="672" />
<p class="caption">
Segmentation of trial one based on the complexity coefficient <span class="math inline">\(B\)</span>. Only spectral features are shown.
</p>
</div>
<pre class="r"><code>  # dev.off() </code></pre>
<pre class="r"><code>  knitr::read_chunk(&quot;../code/eeg-tables.R&quot;)</code></pre>
<pre class="r"><code>  library(dplyr)
  
  prefix = &quot;eeg&quot;
  vecmeans &lt;- readRDS(cache_file(&quot;vecmeans&quot;, prefix))
  ABmeans &lt;- readRDS(cache_file(&quot;ABmeans&quot;, prefix))
  
  ABacc &lt;- ABmeans %&gt;% lapply(., function(x) x[&quot;Balanced.Accuracy&quot;, ]) %&gt;% 
              bind_rows(.) %&gt;% 
              data.frame
  vecacc &lt;- vecmeans %&gt;% lapply(., function(x) x[&quot;Balanced.Accuracy&quot;, ]) %&gt;% 
              bind_rows(.) %&gt;% 
              data.frame
  combacc &lt;- rbind(ABacc, vecacc)
  
  names(combacc) &lt;- paste0(&quot;ch&quot;, 1:6)
  methods &lt;- c(&quot;A&quot;, &quot;B&quot;, &quot;A+B&quot;, &quot;8&quot;, &quot;15&quot;, &quot;30&quot;)
  row.names(combacc) &lt;- methods
  combacc &lt;- apply(combacc, 2, round, digits = 2)
  
  names(combacc) &lt;- paste0(&quot;Channel &quot;, 1:6)
  knitr::kable(combacc, caption = &quot;Balanced accuracy of each models and channel combination.&quot;)</code></pre>
<table>
<caption>Balanced accuracy of each models and channel combination.</caption>
<thead>
<tr class="header">
<th></th>
<th align="right">ch1</th>
<th align="right">ch2</th>
<th align="right">ch3</th>
<th align="right">ch4</th>
<th align="right">ch5</th>
<th align="right">ch6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td align="right">0.81</td>
<td align="right">0.78</td>
<td align="right">0.70</td>
<td align="right">0.74</td>
<td align="right">0.56</td>
<td align="right">0.63</td>
</tr>
<tr class="even">
<td>B</td>
<td align="right">0.84</td>
<td align="right">0.76</td>
<td align="right">0.71</td>
<td align="right">0.73</td>
<td align="right">0.61</td>
<td align="right">0.63</td>
</tr>
<tr class="odd">
<td>A+B</td>
<td align="right">0.79</td>
<td align="right">0.74</td>
<td align="right">0.73</td>
<td align="right">0.72</td>
<td align="right">0.55</td>
<td align="right">0.59</td>
</tr>
<tr class="even">
<td>8</td>
<td align="right">0.86</td>
<td align="right">0.83</td>
<td align="right">0.74</td>
<td align="right">0.73</td>
<td align="right">0.73</td>
<td align="right">0.77</td>
</tr>
<tr class="odd">
<td>15</td>
<td align="right">0.84</td>
<td align="right">0.84</td>
<td align="right">0.75</td>
<td align="right">0.71</td>
<td align="right">0.72</td>
<td align="right">0.75</td>
</tr>
<tr class="even">
<td>30</td>
<td align="right">0.79</td>
<td align="right">0.77</td>
<td align="right">0.75</td>
<td align="right">0.77</td>
<td align="right">0.74</td>
<td align="right">0.73</td>
</tr>
</tbody>
</table>
<pre class="r"><code>  knitr::read_chunk(&quot;../code/eeg-classify-roc-import.R&quot;)</code></pre>
<pre class="r"><code>  library(ggplot2)
  library(dplyr)
  library(ecomplex)
  library(randomForest)
  library(tssegment)
  library(caret)
  
  prefix    = &quot;eeg&quot;
  seed      = 2017
  chs       = 1:6
  from_cache = TRUE
  window    = 240 
  len = window/2
  
  
  # Derived features. 30 Trials : 6 channels : 15 features
  feature_df &lt;-readRDS(cache_file(&quot;mod_all_features&quot;, prefix))
  # Load meta data 
  trial_df &lt;- readRDS(cache_file(&quot;mod_trial_segments&quot;, &quot;eeg&quot;))
  # tdf &lt;- trial_df[trial_df$window == window, ]
  
  # Select trials with 4 minute windows and 
  # combine feature data frames with metadata
  df &lt;- do.call(rbind, feature_df)
  df &lt;- df %&gt;% cbind(trial_df) 
  df &lt;- dplyr::filter(df, window == 240)
  df$trial &lt;- 1:26</code></pre>
</div>
<div id="trial" class="section level2">
<h2>Trial</h2>
<pre class="r"><code>  knitr::read_chunk(&quot;../code/eeg-trial-plot.R&quot;)</code></pre>
<pre class="r"><code>  library(dplyr)
  
  from_cache = TRUE
  
  plot_trial &lt;- function(df_){
    plot( 
          y,  
          xlim = c(0, max_end), 
          ylim = c(-0.5, 0.5),
          lwd = 0.2,
          lty = 3, 
          col = &quot;gray40&quot;,
          type = &#39;l&#39;, 
          xlab = &#39;&#39;, 
          ylab = &#39;&#39;, 
          yaxt = &#39;n&#39;,
          xaxt = &#39;n&#39;
          )
    
    for(k in (1:dim(df_)[1])){         
           
            rcol &lt;- keycols[df_$col_key[k]]
            if(df_$col_key[k]!=4){
            count &lt;&lt;- count + 1
            rect((
                  df_$stim_start[k]-240), 
                  -0.5, 
                  df_$stim_start[k], 
                  0.5, 
                  col = rcol,   
                  border = &quot;transparent&quot;)
                  text(df_$stim_start[k]-120, 0, paste0(count),
                  cex = 1.3, 
                  col = &quot;gray90&quot;
                 )
          }
  
        abline(v = (df_$stim_start[k]+1), col = &quot;chartreuse3&quot;, lwd = 3)
    }
   
  }
  count = 0
   
  metadf &lt;- readRDS(cache_file(&quot;windows2&quot;, &quot;meta&quot;))
  # Fix errror: 
  metadf$col_key[13] &lt;- 4
  trial_keys &lt;- unique(metadf$key)
  max_end &lt;- max(metadf$stim_end) 
  
  x &lt;- (0:max_end)
  y &lt;- rep(0, length(x))
  
  keycols &lt;- eegpalette()
  # pdf(file.path(getwd(), paste0(&quot;figures/&quot;, prefix, &quot;-param-plots-notrandom.pdf&quot;)), 
  #     width = 9, height = 4)
  par(mfrow = c(8,2), mar = c(1, 0.5, 1, 0.5), cex.axis = 1.4, cex.lab = 1.4)
  
  
  for(k in 1:length(trial_keys)){
    df_ &lt;-  metadf %&gt;% dplyr::filter(key == trial_keys[k])
    plot_trial(df_)
  }
  
  plot(1, type = &#39;n&#39;, axes = &quot;FALSE&quot;)
  legend(x = &quot;center&quot;, inset = 0,
         c(&quot;No response&quot;, &quot;1st response &quot;, &quot;2nd response&quot;), 
          col = keycols, pch = 15, cex = 1.3, horiz = TRUE) 
          
  plot(1, type = &#39;n&#39;, axes = &quot;FALSE&quot;)</code></pre>
<div class="figure" style="text-align: center">
<img src="figure/seizure-prediction.Rmd/trial-plot2-1.png" alt="Schematic of the trial time periods. A seizures is indicated as a 'repsonse' and initial seizures and secondary seizures are indicated by color." width="672" />
<p class="caption">
Schematic of the trial time periods. A seizures is indicated as a ‘repsonse’ and initial seizures and secondary seizures are indicated by color.
</p>
</div>
<pre class="r"><code>  # dev.off()</code></pre>
<pre class="r"><code>  knitr::read_chunk(&quot;../code/eeg-cv-ch1-plot.R&quot;)</code></pre>
<pre class="r"><code>  library(ggplot2)
  prefix = &quot;eeg&quot;
  
  palette(eegpalette())
  
  meta_df &lt;- readRDS(cache_file(&quot;windows2&quot;, &quot;meta&quot;))
  predict &lt;- readRDS(cache_file(&quot;cv_results_ch_1&quot;, &quot;eeg&quot;) )
  predict_df &lt;- predict$df
  colkey &lt;- predict_df$trial_type &lt;- meta_df %&gt;% 
            dplyr::filter(window == 240) %&gt;% 
            dplyr::select(col_key)
  colkey &lt;- colkey[[1]]
  # colkey[colkey == 3] &lt;- 2
  
  thresholds &lt;- readRDS(cache_file(&quot;cvthresholds&quot;, prefix))
  
  
  tnames &lt;- paste0(&quot;Trial &quot;, 1:26)
  tnames &lt;- factor(tnames, levels = tnames)
  
  names(predict_df) &lt;- c(&quot;response&quot;,&quot;probability&quot;, &quot;trialnum&quot;, &quot;ground&quot;)
  
  # Edited : Seizure vs No seizure
  ggplot(predict_df, aes( x = tnames, y = probability)) + 
    geom_point(stat=&#39;identity&#39;, aes(col=as.factor(colkey)), size= 4) +
    scale_color_manual(name=&quot;&quot;, 
                       labels = c(&quot;No response&quot;, &quot;Seizure response&quot;, &quot;2nd response&quot;), 
                       values = eegpalette()) +
                       labs(y = &quot;Probability&quot;, x = &quot;&quot;) +
                       coord_flip() + 
                       geom_hline(yintercept=thresholds[[1]], colour = &quot;chartreuse3&quot;) +
                       theme_bw() + 
                       theme(text = element_text(size= 16),
                         axis.text.x = element_text(size = 16),  
                         panel.background = element_rect(fill = &quot;transparent&quot;, colour = NA), 
                         # panel.background = element_blank(), 
                        plot.background = element_blank(), 
                        legend.background = element_rect(fill = &quot;transparent&quot;, colour = NA))</code></pre>
<div class="figure" style="text-align: center">
<img src="figure/seizure-prediction.Rmd/cv-ch2-1.png" alt="Probability of seizure for model built on channel 1 using complexity coefficients." width="672" />
<p class="caption">
Probability of seizure for model built on channel 1 using complexity coefficients.
</p>
</div>
<pre class="r"><code>  palette(&quot;default&quot;)</code></pre>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<!-- Insert the session information into the document -->
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.4.1 (2017-06-30)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 14.04.5 LTS

Matrix products: default
BLAS: /usr/lib/libblas/libblas.so.3.0
LAPACK: /usr/lib/lapack/liblapack.so.3.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] caret_6.0-76         lattice_0.20-35      tssegment_0.0.0.9000
 [4] randomForest_4.6-12  bindrcpp_0.2         ecomplex_0.0.1      
 [7] viridis_0.3.4        dplyr_0.7.1          ggplot2_2.2.1       
[10] eegcomplex_0.0.0.1  

loaded via a namespace (and not attached):
 [1] splines_3.4.1         foreach_1.4.3         assertthat_0.2.0     
 [4] stats4_3.4.1          highr_0.6             yaml_2.1.14          
 [7] backports_1.0.5       quantreg_5.26         glue_1.1.1           
[10] quadprog_1.5-5        pROC_1.9.1            digest_0.6.12        
[13] sapa_2.0-2            minqa_1.2.4           colorspace_1.2-6     
[16] htmltools_0.3.6       Matrix_1.2-10         plyr_1.8.4           
[19] timeDate_3012.100     pkgconfig_2.0.1       devtools_1.13.2      
[22] SparseM_1.7           scales_0.4.1          ForeCA_0.2.4         
[25] MatrixModels_0.4-1    ifultools_2.0-4       lme4_1.1-13          
[28] pracma_2.0.7          git2r_0.18.0          tibble_1.3.3         
[31] mgcv_1.8-12           car_2.1-4             withr_1.0.2          
[34] nnet_7.3-12           lazyeval_0.2.0        pbkrtest_0.4-6       
[37] magrittr_1.5          memoise_1.1.0         evaluate_0.10.1      
[40] nlme_3.1-128          MASS_7.3-45           xml2_1.1.1           
[43] ggthemes_3.4.0        tools_3.4.1           stringr_1.2.0        
[46] munsell_0.4.3         compiler_3.4.1        timeSeries_3022.101.2
[49] fArma_3010.79         rlang_0.1.1           grid_3.4.1           
[52] nloptr_1.0.4          iterators_1.0.8       labeling_0.3         
[55] fractaldim_0.8-4      rmarkdown_1.6         gtable_0.2.0         
[58] ModelMetrics_1.1.0    codetools_0.2-15      fracdiff_1.4-2       
[61] gmwm_2.0.0            abind_1.4-3           roxygen2_6.0.1       
[64] reshape2_1.4.1        R6_2.2.2              gridExtra_2.2.1      
[67] knitr_1.16            bindr_0.1             commonmark_1.2       
[70] fBasics_3011.87       rprojroot_1.2         stringi_1.1.5        
[73] pdc_1.0.3             parallel_3.4.1        Rcpp_0.12.11         
[76] splus2R_1.2-1        </code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
